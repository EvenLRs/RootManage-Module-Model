MODDIR=${0%/*}
LOG_FILE="${MODDIR}/MagicNet.log"
mihomo_dir="${MODDIR}/mihomo/"
mihomo_config="${MODDIR}/mihomo/config.yaml"
mihomo="/system/bin/mihomo"
MODULE_PROP="$MODDIR/module.prop"
ENV_FILE="$MODDIR/env"

extract_sub_url() {
    # ç²¾ç¡®æå– myclash èŠ‚ç‚¹çš„ url
    url=$(grep -A 4 '"myclash":' "${mihomo_config}" | grep 'url:' | awk '{print $2}' | tr -d '"')
    echo "${url}"
}

set_sub_url() {
    new_url=$1
    if [ -z "$new_url" ]; then
        log Error "æ–° URL ä¸èƒ½ä¸ºç©º"
        return 1
    fi
    # ä½¿ç”¨ sed åœ¨ myclash èŠ‚ç‚¹èŒƒå›´å†…æ›¿æ¢ url
    sed -i '/"myclash":/,/url:/s|url:.*|url: "'"$new_url"'"|' "${mihomo_config}"
    
    log INFO "å·²å°†è®¢é˜…é“¾æ¥æ›´æ–°ä¸º: ${new_url}"
}

set_module_description(){
    local new_description="$1"
    sed -i "s/^description=.*/description=$(printf '%s' "${new_description//\//\\/}")/" "${MODULE_PROP}"
}

formatted_date() {
    date +"%Y-%m-%d %H:%M:%S.%3N"
}

normal="\033[0m" # No Color
orange="\033[1;38;5;208m"
red="\033[1;31m"
green="\033[1;32m"
yellow="\033[1;33m"
blue="\033[1;34m"

log() {
    [ ! -f "${LOG_FILE}" ] && touch "${LOG_FILE}"

    case $1 in
        INFO) color="${blue}" ;;
        Error) color="${red}" ;;
        Warning) color="${yellow}" ;;
        *) color="${green}" ;;
    esac
    current_time=$(formatted_date)
    message="${current_time} [$1]: $2"
    if [ -t 1 ]; then
        echo -e "${color}${message}${normal}"
    else
        echo "${message}" >> "${LOG_FILE}" 2>&1
    fi
}

clean_old_logs() {
    latest_time=$(tail -n 1 "${MODDIR}/MagicNet.log" | awk '{print $1 " " $2}')
    [ -z "$latest_time" ] && return

    latest_timestamp=$(date -d "$latest_time" +%s 2>/dev/null)
    [ -z "$latest_timestamp" ] && return

    awk -v latest_timestamp="$latest_timestamp" '
    {
        log_time = $1 " " $2
        gsub(/[-:]/, " ", log_time)
        log_timestamp = mktime(log_time)
        if (latest_timestamp - log_timestamp <= 86400) {
            print $0
        }
    }' "${MODDIR}/MagicNet.log" > "${MODDIR}/MagicNet.log.tmp" && mv "${MODDIR}/MagicNet.log.tmp" "${MODDIR}/MagicNet.log"
}

create_tun() {
    mkdir -p /dev/net
    log INFO "åˆ›å»º/dev/net/ç›®å½•"

    [ ! -L /dev/net/tun ] && ln -s /dev/tun /dev/net/tun
    log INFO "åˆ›å»º/dev/net/tunç¬¦å·é“¾æ¥"
    
    if [ ! -c "/dev/net/tun" ]; then
        log Error "æ— æ³•åˆ›å»º /dev/net/tunï¼Œå¯èƒ½çš„åŸå› ï¼š"
        log Warning "ç³»ç»Ÿä¸æ”¯æŒ TUN/TAP é©±åŠ¨æˆ–å†…æ ¸ä¸å…¼å®¹"
        exit 1
    fi
    log INFO "/dev/net/tun ä¸ºå­—ç¬¦è®¾å¤‡ï¼Œæ£€æŸ¥é€šè¿‡"
}

mihomo_prepare() {
    if ! [ -f "${mihomo_config}" ]; then
        log Error "é…ç½®æ–‡ä»¶ ${mihomo_config} ä¸å­˜åœ¨"
        exit 1
    else
        log INFO "åŠ è½½é…ç½®æ–‡ä»¶: ${mihomo_config}"
        
        # å¾ªç¯æå–URLå¹¶è¿›è¡Œåˆ¤æ–­
        while true; do
            extracted_url=$(extract_sub_url)
            if [ "$extracted_url" != "è®¢é˜…é“¾æ¥" ]; then
                log INFO "æå–åˆ°çš„è®¢é˜…é“¾æ¥: ${extracted_url}"
                break
            else   
                log INFO "mihomoç­‰å¾…ä¸€ä¸ªè®¢é˜…é“¾æ¥ é—´éš”10ç§’"      
                set_module_description "æ­£åœ¨ç­‰å¾…ä¸€ä¸ªè®¢é˜…é“¾æ¥ğŸ“ è¯·å‰å¾€ä¿®æ”¹ $ENV_FILE æˆ–è€… $mihomo_config è¯»å–åˆ°çš„URL:$extracted_url"

                set_sub_url $(grep "^url=" "$ENV_FILE" | cut -d'=' -f2)
                log INFO "å°è¯•ä»å¤‡ä»½æ¢å¤"   
            fi
            # ç­‰ä½ å¡«è®¢é˜…é“¾æ¥å‘¢
            sleep 10
        done
    fi
    log INFO "å¤‡ä»½é“¾æ¥"
    echo "url=$extracted_url" > $ENV_FILE
    
}

mihomo_run() {
    log INFO "å¯åŠ¨ mihomo å†…æ ¸..."
    mihomo_prepare

    if [ -x "${mihomo}" ]; then
        # å¯åŠ¨ mihomo å†…æ ¸ï¼Œå¹¶å°†æ—¥å¿—è®°å½•åˆ°æŒ‡å®šæ–‡ä»¶
        set_module_description "mihomoå¯åŠ¨!ğŸ›¡ï¸[å†…æ ¸å¯åŠ¨æ—¶é—´ğŸ•“]-$(date '+%Y-%m-%d %H:%M:%S') [mihomo]-$(${mihomo} -v) è¯·æ³¨æ„æŸ¥çœ‹æ—¥å¿—!"
        "${mihomo}" -d "${mihomo_dir}" -f "${mihomo_config}" >> "${LOG_FILE}" 2>&1
    else
        log Error "æœªæ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œçš„ ${mihomo}"
        exit 1
    fi

}
